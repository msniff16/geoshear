<html>
<head>
   <title>Shear Geometry</title>
</head>

<link rel="stylesheet" type="text/css" href="css/style.css"/>
<script src="js/three.min.js"></script>
<script src="js/controls/TrackballControls.js"></script>
<script src="js/renderers/Projector.js"></script>
<script src="js/renderers/SoftwareRenderer.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.min.js"></script>
<script src="js/app.js"></script>
<script src="js/controller.js"></script>

<body ng-controller="controller">

<!-- Matrix Inputs -->
<div class="matrixBox">

  <p>Shear Transformation</p>

  <form method="get" action="">

    <input type="text" placeholder="Syx" name="syx" />
    <input type="text" placeholder="Szx" name="szx" />
    <input type="text" placeholder="Sxy" name="sxy" />
    <input type="text" placeholder="Szy" name="szy" />
    <input type="text" placeholder="Sxz" name="sxz" />
    <input type="text" placeholder="Syz" name="syz" />

    <input type="submit" value="Transform" />

  </form>

</div>

<!-- Scene -->
<div id="scene"></div>

<!-- Main -->
<script>

    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

   // global vars
   var camera, controls, scene, renderer, cube;
   var start = Date.now();

   // setup and animate
   init();
   animate();

   // setup
   function init() {


      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 10000);
      camera.position.z = 1000;

      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);

      container = document.getElementById('scene');
      container.appendChild(renderer.domElement);
      controls = new THREE.TrackballControls( camera, container);

      // New cube shape
      var geometry = new THREE.BoxGeometry( 500, 500, 500, 10, 30, 30);
      var material = new THREE.MeshBasicMaterial({color: 0x00B4FF, wireframe: true});

      // shear matrix
      // ref: http://www.flipcode.com/documents/matrfaq.html#Q43
      //        | 1    Syx  Szx  0 |
      //        |                  |
      //        | Sxy  1    Szy  0 |
      //    M = |                  |
      //        | Sxz  Syz  1    0 |
      //        |                  |
      //        | 0    0    0    1 |
      //        |                  |

      var matrix = new THREE.Matrix4();

      var Syx = getParameterByName('syx'),
          Szx = getParameterByName('szx'),
          Sxy = getParameterByName('sxy'),
          Szy = getParameterByName('szy'),
          Sxz = getParameterByName('sxz'),
          Syz = getParameterByName('syz');

      matrix.set(   1,   Syx,  Szx,  0,
                  Sxy,     1,  Szy,  0,
                  Sxz,   Syz,   1,   0,
                    0,     0,   0,   1  );


      // apply matrix
      geometry.applyMatrix( matrix );
      geometry.dynamic = true;

      // add axes
      // axes = buildAxes(1000);

      // add  cube
      cube = new THREE.Mesh(geometry, material);
      scene.add(cube);

      // rando effects
      cube.castShadow = true;
      cube.receiveShadow = true;
      // scene.add(axes);

      window.addEventListener( 'resize', onWindowResize, false );

   }

   // build axes
   function buildAxes( length ) {

     var axes = new THREE.Object3D();

     axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( length, 0, 0 ), 0xFF0000, false ) ); // +X
     axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( -length, 0, 0 ), 0xFF0000, true) ); // -X
     axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, length, 0 ), 0x00FF00, false ) ); // +Y
     axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, -length, 0 ), 0x00FF00, true ) ); // -Y
     axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, 0, length ), 0x0000FF, false ) ); // +Z
     axes.add( buildAxis( new THREE.Vector3( 0, 0, 0 ), new THREE.Vector3( 0, 0, -length ), 0x0000FF, true ) ); // -Z

     return axes;

   }

   // build axes
   function buildAxis( src, dst, colorHex, dashed ) {

        var geom = new THREE.Geometry(),
            mat;

        if(dashed) {
                mat = new THREE.LineDashedMaterial({ linewidth: 3, color: colorHex, dashSize: 3, gapSize: 3 });
        } else {
                mat = new THREE.LineBasicMaterial({ linewidth: 3, color: colorHex });
        }

        geom.vertices.push( src.clone() );
        geom.vertices.push( dst.clone() );
        geom.computeLineDistances(); // This one is SUPER important, otherwise dashed lines will appear as simple plain lines

        var axis = new THREE.Line( geom, mat, THREE.LinePieces );

        return axis;

   }

   // resize
   function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize( window.innerWidth, window.innerHeight );
   }

   // animate
   function animate() {
      requestAnimationFrame( animate );
      render();
   }

   // render
   function render() {
      var timer = Date.now() - start;
      cube.rotation.y = timer * 0.0003;
      controls.update();
      renderer.render( scene, camera );
   }

</script>

</body>
</html>